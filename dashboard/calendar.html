<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - ReservasPro</title>
    <link rel="stylesheet" href="../css/mobile-optimization.css">
    <script src="../js/multilanguage.js"></script>
    <script src="../js/common-header.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        .calendar-header {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .nav-btn {
            background: #1e40af;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .nav-btn:hover { background: #1e3a8a; }
        
        .current-week {
            font-weight: 600;
            color: #1e40af;
            font-size: 1.1rem;
        }
        
        .add-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .add-btn:hover { background: #047857; }
        
        .calendar-grid {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .time-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .day-header {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #64748b;
            border-right: 1px solid #e2e8f0;
        }
        
        .time-column {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #64748b;
            border-right: 2px solid #e2e8f0;
        }
        
        .calendar-body {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
        }
        
        .time-slot {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: #64748b;
            border-right: 2px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        .calendar-cell {
            padding: 0.5rem;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            min-height: 60px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        
        .calendar-cell:hover {
            background: #eff6ff;
        }
        
        .appointment {
            background: #1e40af;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 1px 0;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .appointment.pending { background: #d97706; }
        .appointment.confirmed { background: #059669; }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1e40af;
        }
        
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            flex: 1;
        }
        
        .btn-primary {
            background: #1e40af;
            color: white;
        }
        
        .btn-primary:hover { background: #1e3a8a; }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .btn-secondary:hover { background: #475569; }
        
        @media (max-width: 768px) {
            .calendar-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .time-header,
            .calendar-body {
                grid-template-columns: 60px repeat(7, 1fr);
            }
            
            .day-header,
            .time-slot {
                font-size: 0.75rem;
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="calendar-header">
            <div class="calendar-nav">
                <button class="nav-btn" onclick="changeWeek(-1)">‹</button>
                <div class="current-week" id="currentWeek">Semana Actual</div>
                <button class="nav-btn" onclick="changeWeek(1)">›</button>
            </div>
            <button class="add-btn" onclick="openModal()">
                ➕ Agregar Cita
            </button>
        </div>
        
        <div class="calendar-grid">
            <div class="time-header">
                <div class="time-column">Hora</div>
                <div class="day-header">Lun</div>
                <div class="day-header">Mar</div>
                <div class="day-header">Mié</div>
                <div class="day-header">Jue</div>
                <div class="day-header">Vie</div>
                <div class="day-header">Sáb</div>
                <div class="day-header">Dom</div>
            </div>
            <div class="calendar-body" id="calendarBody">
                <!-- Generated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div class="modal" id="appointmentModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1.5rem; color: #1e40af;">Agregar Cita</h2>
            <form id="appointmentForm">
                <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" id="clientName" required placeholder="Nombre del cliente">
                </div>
                <div class="form-group">
                    <label>Servicio</label>
                    <select id="service" required>
                        <option value="">Selecciona servicio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="appointmentDate" required>
                </div>
                <div class="form-group">
                    <label>Hora</label>
                    <select id="appointmentTime" required>
                        <option value="">Selecciona hora</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Agregar Cita</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let currentWeekStart = new Date();
        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        let services = JSON.parse(localStorage.getItem('services') || '[]');
        let schedule = JSON.parse(localStorage.getItem('schedule') || '{}');
        
        // Initialize
        function init() {
            loadConfiguration();
            setCurrentWeek();
            generateCalendar();
            setupModal();
        }
        
        function loadConfiguration() {
            // Load services
            if (services.length === 0) {
                services = [
                    { id: 1, name: 'Corte', duration: 60, price: 25 },
                    { id: 2, name: 'Tinte', duration: 90, price: 45 }
                ];
                localStorage.setItem('services', JSON.stringify(services));
            }
            
            // Load schedule
            if (!schedule.openTime) {
                schedule = {
                    openTime: '09:00',
                    closeTime: '18:00',
                    slotInterval: 30,
                    workingDays: [1, 2, 3, 4, 5]
                };
                localStorage.setItem('schedule', JSON.stringify(schedule));
            }
        }
        
        function setCurrentWeek() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(now);
            currentWeekStart.setDate(now.getDate() + mondayOffset);
            
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            document.getElementById('currentWeek').textContent = 
                `${currentWeekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
        }
        
        function generateCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            const startHour = parseInt(schedule.openTime.split(':')[0]);
            const endHour = parseInt(schedule.closeTime.split(':')[0]);
            const interval = schedule.slotInterval;
            
            for (let hour = startHour; hour < endHour; hour++) {
                for (let minutes = 0; minutes < 60; minutes += interval) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    
                    // Time slot
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = timeStr;
                    calendarBody.appendChild(timeSlot);
                    
                    // Days
                    for (let day = 0; day < 7; day++) {
                        const date = new Date(currentWeekStart);
                        date.setDate(currentWeekStart.getDate() + day);
                        const dateStr = date.toISOString().split('T')[0];
                        
                        const cell = document.createElement('div');
                        cell.className = 'calendar-cell';
                        cell.onclick = () => quickAdd(dateStr, timeStr);
                        
                        // Check for appointments
                        const appointment = appointments.find(a => a.date === dateStr && a.time === timeStr);
                        if (appointment) {
                            const aptDiv = document.createElement('div');
                            aptDiv.className = `appointment ${appointment.status}`;
                            aptDiv.textContent = `${appointment.service} - ${appointment.client}`;
                            cell.appendChild(aptDiv);
                        }
                        
                        calendarBody.appendChild(cell);
                    }
                }
            }
        }
        
        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            setCurrentWeek();
            generateCalendar();
        }
        
        function setupModal() {
            // Setup service options
            const serviceSelect = document.getElementById('service');
            serviceSelect.innerHTML = '<option value="">Selecciona servicio</option>';
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.name;
                option.textContent = `${service.name} - €${service.price}`;
                serviceSelect.appendChild(option);
            });
            
            // Setup time options
            const timeSelect = document.getElementById('appointmentTime');
            timeSelect.innerHTML = '<option value="">Selecciona hora</option>';
            
            const startHour = parseInt(schedule.openTime.split(':')[0]);
            const endHour = parseInt(schedule.closeTime.split(':')[0]);
            const interval = schedule.slotInterval;
            
            for (let hour = startHour; hour < endHour; hour++) {
                for (let minutes = 0; minutes < 60; minutes += interval) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = timeStr;
                    timeSelect.appendChild(option);
                }
            }
        }
        
        function quickAdd(date, time) {
            document.getElementById('appointmentDate').value = date;
            document.getElementById('appointmentTime').value = time;
            openModal();
        }
        
        function openModal() {
            document.getElementById('appointmentModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('appointmentModal').classList.remove('active');
            document.getElementById('appointmentForm').reset();
        }
        
        // Form submission
        document.getElementById('appointmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const appointment = {
                id: Date.now(),
                client: document.getElementById('clientName').value,
                service: document.getElementById('service').value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                status: 'confirmed'
            };
            
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            generateCalendar();
            closeModal();
            
            alert('¡Cita creada exitosamente! 🎉');
        });
        
        // Close modal when clicking outside
        document.getElementById('appointmentModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>